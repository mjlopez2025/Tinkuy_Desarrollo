<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="login.css">
  <title>Recuperar Contraseña | Tinkuy</title>
</head>
<body>
  <div class="container1">
    <div class="logo-container">
      <div class="image-side">
        <img src="../imagenes/logo.png" alt="Logo UNDAV" class="logo-undav">
      </div>
      <div class="tincuy">
        <p style="font-size: 10pt; font-weight: normal;">Tinkuy: Del quechua, "Encuentro" o "Unión armónica". <br>
          En la tradición andina, representa la convergencia de fuerzas complementarias para crear algo superior.</p>
      </div>
    </div>
    <div class="login-container">
      <h1>Recuperar Contraseña</h1>
      <form id="recoveryForm">
        <div class="input-group">
          <label for="username">Nombre de Usuario</label>
          <div class="input-with-icon">
            <input type="text" id="username" name="username" placeholder="Tu nombre de usuario" required autocomplete="off">
            <i class="fas fa-user icon"></i>
          </div>
        </div>
        
        <div class="input-group">
          <label for="email">Correo Electrónico</label>
          <div class="input-with-icon">
            <input type="email" id="email" name="email" placeholder="tucorreo@undav.edu.ar" required autocomplete="off">
            <i class="fas fa-envelope icon"></i>
          </div>
        </div>
        
        <button type="submit" class="btn-login" id="submitBtn">
          <span class="btn-text">Enviar enlace</span>
        </button>
        <div class="register-link">
          <p>¿Recordaste tu contraseña? <a href="index.html" class="register-anchor">Inicia sesión aquí</a></p>
        </div>
      </form>
    </div>
  </div>
  <p class="footer-text">
    <img class="logo_undav" src="../imagenes/undav.png" style="width: 35px !important; height: auto !important;">
    v.1.0 &copy; 2025 - Desarrollado por el Área de Sistemas de la Universidad Nacional de Avellaneda.
  </p>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
    const recoveryForm = document.getElementById('recoveryForm');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = submitBtn.querySelector('.btn-text');

    recoveryForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        setLoadingState(true);

        try {
            const formData = {
                username: document.getElementById('username').value.trim(),
                email: document.getElementById('email').value.trim()
            };

            // Mostramos los datos que se enviarán
            console.log("Enviando datos:", formData);

            const response = await fetch('recuperar_procesar.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            // Verificamos primero el estado de la respuesta
            if (!response.ok) {
                const errorText = await response.text();
                console.error("Error del servidor:", errorText);
                throw new Error(`Error del servidor: ${response.status} ${response.statusText}`);
            }

            // Verificamos el content-type antes de parsear JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error("Respuesta no JSON:", text);
                throw new Error('El servidor respondió con un formato inesperado');
            }

            const data = await response.json();
            console.log("Respuesta recibida:", data);

            if (data.success) {
                alert('¡Se ha enviado un enlace de recuperación a tu correo!');
                window.location.href = 'index.html';
            } else {
                showError(data.errors?.join('<br>') || 'Error desconocido del servidor');
            }
        } catch (error) {
            console.error('Error completo:', error);
            if (error instanceof SyntaxError) {
                showError('El servidor respondió con datos inválidos. Por favor, contacta al administrador.');
            } else {
                showError(error.message || 'Error al conectar con el servidor.');
            }
        } finally {
            setLoadingState(false);
        }
    });

      function showError(message) {
        let errorContainer = document.getElementById('error-container');
        if (!errorContainer) {
          errorContainer = document.createElement('div');
          errorContainer.id = 'error-container';
          errorContainer.className = 'error-container';
          recoveryForm.prepend(errorContainer);
        }
        errorContainer.innerHTML = `<div class="error-content"><i class="fas fa-exclamation-circle"></i><div>${message}</div></div>`;
        errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      function setLoadingState(isLoading) {
        if (isLoading) {
          submitBtn.disabled = true;
          btnText.innerHTML = '<i class="fas fa-spinner spinner"></i> Enviando...';
        } else {
          submitBtn.disabled = false;
          btnText.textContent = 'Enviar enlace';
        }
      }
    });
  </script>
</body>
</html>